name: ğŸ¶ Reviewdog - Automated Code Review

on:
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'

jobs:
  # ESLint ã«ã‚ˆã‚‹ JavaScript ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
  eslint-reviewdog:
    name: ğŸ” ESLint Review (JavaScript)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ¶ Run ESLint with reviewdog
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          eslint_flags: 'src/**/*.js'
          filter_mode: 'diff_context'
          fail_on_error: false
          level: 'warning'

  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆPrettier ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
  prettier-reviewdog:
    name: ğŸ¨ Code Formatting Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ¨ Check code formatting
        run: |
          # PrettierãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯è­¦å‘Šã®ã¿è¡¨ç¤º
          if command -v prettier &> /dev/null; then
            npx prettier --check 'src/**/*.js' || echo "::warning::ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          else
            echo "::warning::Prettier is not installed. Consider adding it for better code formatting."
          fi

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ with reviewdog
  security-reviewdog:
    name: ğŸ›¡ï¸ Security Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Run security audit
        run: |
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œä¸­..."
          npm audit --audit-level=moderate --format=json > audit-results.json || true
          
          # è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®å‡¦ç†
          if [ -s audit-results.json ] && [ "$(cat audit-results.json)" != "{}" ]; then
            echo "::warning::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚npm audit fix ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
          else
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Œäº† - é‡è¦ãªè„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi

  # ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚µãƒãƒªãƒ¼
  review-summary:
    name: ğŸ“Š Review Summary
    runs-on: ubuntu-latest
    needs: [eslint-reviewdog, prettier-reviewdog, security-reviewdog]
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ“Š Generate review summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = {
              eslint: '${{ needs.eslint-reviewdog.result }}',
              prettier: '${{ needs.prettier-reviewdog.result }}',
              security: '${{ needs.security-reviewdog.result }}'
            };
            
            let summary = '## ğŸ¶ Reviewdog è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n';
            
            if (results.eslint === 'success') {
              summary += 'âœ… **ESLint**: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†\n';
            } else {
              summary += 'âš ï¸ **ESLint**: ã‚³ãƒ¼ãƒ‰å“è³ªã®æ”¹å–„ç‚¹ãŒã‚ã‚Šã¾ã™\n';
            }
            
            if (results.prettier === 'success') {
              summary += 'âœ… **Prettier**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†\n';
            } else {
              summary += 'âš ï¸ **Prettier**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ”¹å–„ç‚¹ãŒã‚ã‚Šã¾ã™\n';
            }
            
            if (results.security === 'success') {
              summary += 'âœ… **Security**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†\n';
            } else {
              summary += 'âš ï¸ **Security**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç¢ºèªãŒå¿…è¦ã§ã™\n';
            }
            
            summary += '\n---\n*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ by reviewdog ğŸ¶*';
            
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }