name: CD - Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  NODE_VERSION: '20.x'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # CI ãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ç¢ºèªï¼‰
  pre-deployment-checks:
    name: ğŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Final lint & type check
        run: npm run ci:lint

      - name: ğŸ›¡ï¸ Final security check
        run: npm run ci:security

      - name: ğŸ§ª Final test suite
        run: npm run ci:test

  # æœ¬ç•ªãƒ“ãƒ«ãƒ‰
  production-build:
    name: ğŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for production
        run: npm run build:production
        env:
          NODE_ENV: production

      - name: ğŸ“Š Build artifact upload
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            .next/
            package.json
            package-lock.json
          retention-days: 30

  # Vercel ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-to-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [production-build]
    environment: production
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: ğŸ—ï¸ Pull Vercel environment information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ—ï¸ Build project artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸš€ Deploy to Vercel
        id: deployment
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸš€ Deployed to: $DEPLOYMENT_URL"

      - name: ğŸ“ Comment PR with deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ **Production deployment successful!**\n\nDeployment URL: ${{ steps.deployment.outputs.deployment_url }}'
            })

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  post-deployment-tests:
    name: ğŸ” Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-to-vercel]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Health check - Homepage
        run: |
          echo "ğŸ” Checking homepage availability..."
          curl -f -s -o /dev/null https://kotonone.vercel.app || (echo "âŒ Homepage check failed" && exit 1)
          echo "âœ… Homepage is accessible"

      - name: ğŸ” Health check - API endpoints
        run: |
          echo "ğŸ” Checking API endpoint health..."
          # Basic API availability check (adjust URL as needed)
          curl -f -s -o /dev/null https://kotonone.vercel.app/api/health || echo "âš ï¸ API health check endpoint not found (this is expected if not implemented)"
          echo "âœ… Basic deployment verification complete"

  # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
  deployment-success:
    name: âœ… Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-to-vercel, post-deployment-tests]
    if: always() && needs.deploy-to-vercel.result == 'success'
    steps:
      - name: âœ… Deployment success notification
        run: |
          echo "ğŸ‰ Production deployment completed successfully!"
          echo "ğŸ“Š Deployment summary:"
          echo "  â€¢ Environment: Production"
          echo "  â€¢ Platform: Vercel"
          echo "  â€¢ Status: âœ… Success"
          echo "  â€¢ Time: $(date)"

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™
  deployment-failure:
    name: âŒ Deployment Failure Handling
    runs-on: ubuntu-latest
    needs: [deploy-to-vercel, post-deployment-tests]
    if: always() && (needs.deploy-to-vercel.result == 'failure' || needs.post-deployment-tests.result == 'failure')
    steps:
      - name: âŒ Deployment failure notification
        run: |
          echo "âŒ Production deployment failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ› ï¸ Consider manual rollback if necessary"
          exit 1