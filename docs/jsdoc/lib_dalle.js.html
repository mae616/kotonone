<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/dalle.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/dalle.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// DALL-E 3 画像生成API関数
import OpenAI from 'openai';

// OpenAI クライアント初期化
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/**
 * DALL-E 3で画像を生成
 * @param {string} prompt - 画像生成用プロンプト
 * @returns {Promise&lt;string>} - 生成された画像のURL
 */
export async function generateImage(prompt) {
  try {
    console.log('DALL-E 3 画像生成開始');
    console.log('プロンプト:', prompt);
    
    const response = await openai.images.generate({
      model: "dall-e-3",
      prompt: prompt,
      n: 1,
      size: "1792x1024", // 16:9 アスペクト比（OGP最適化）
      quality: "hd",      // 高品質
      style: "natural"    // 自然な写実的スタイル
    });

    const imageUrl = response.data[0]?.url;
    
    if (!imageUrl) {
      throw new Error('画像URLが取得できませんでした');
    }

    console.log('DALL-E 3 画像生成完了:', imageUrl);
    return imageUrl;
  } catch (error) {
    console.error('DALL-E 3 エラー:', error);
    
    // エラーの詳細を確認
    if (error.response?.status === 400) {
      if (error.code === 'content_policy_violation') {
        throw new Error('画像プロンプトがコンテンツポリシーに違反しました');
      }
      throw new Error('画像生成プロンプトに問題があります');
    } else if (error.response?.status === 429) {
      throw new Error('API利用制限に達しました。しばらく待ってから再試行してください');
    } else if (error.response?.status === 500) {
      throw new Error('OpenAI サーバーエラーが発生しました');
    }
    
    throw new Error('画像生成中にエラーが発生しました');
  }
}

/**
 * テーマから直接画像を生成（シンプル版）
 * @param {string} theme - ユーザーのテーマ
 * @returns {Promise&lt;{imageUrl: string, prompt: string}>} - 画像URLとプロンプト
 */
export async function generateImageFromTheme(theme) {
  try {
    // シンプルなプロンプト生成
    const basePrompt = `Abstract watercolor painting representing the emotion "${theme}", soft brushstrokes, gentle colors, peaceful atmosphere, minimalist composition, 16:9 aspect ratio`;
    
    console.log('テーマ直接画像生成:', theme);
    
    const imageUrl = await generateImage(basePrompt);
    
    return {
      imageUrl,
      prompt: basePrompt
    };
  } catch (error) {
    console.error('テーマ画像生成エラー:', error);
    throw error;
  }
}

/**
 * エラー時のフォールバック処理
 * @param {string} theme - ユーザーのテーマ
 * @returns {Object} - フォールバック結果
 */
export function getImageFallback(theme) {
  console.log('画像生成フォールバック実行:', theme);
  
  // プレースホルダー画像URL（アプリ内の静的画像）
  const fallbackImageUrl = '/images/fallback-background.jpg';
  
  return {
    imageUrl: fallbackImageUrl,
    prompt: `Fallback image for theme: ${theme}`,
    isFallback: true
  };
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-GenerateAPI.html">GenerateAPI</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-OpenAI.html">OpenAI</a></li></ul><h3>Global</h3><ul><li><a href="global.html#checkFirebaseImageExists">checkFirebaseImageExists</a></li><li><a href="global.html#cleanupObjectUrls">cleanupObjectUrls</a></li><li><a href="global.html#deleteImageFromStorage">deleteImageFromStorage</a></li><li><a href="global.html#generateDummyImagePrompt">generateDummyImagePrompt</a></li><li><a href="global.html#generateDummyPoem">generateDummyPoem</a></li><li><a href="global.html#generateDummyResponse">generateDummyResponse</a></li><li><a href="global.html#generateImage">generateImage</a></li><li><a href="global.html#generateImageFromTheme">generateImageFromTheme</a></li><li><a href="global.html#getDummyImageUrl">getDummyImageUrl</a></li><li><a href="global.html#getImageFallback">getImageFallback</a></li><li><a href="global.html#getPoemFromFirestore">getPoemFromFirestore</a></li><li><a href="global.html#loadFirebaseImageBlob">loadFirebaseImageBlob</a></li><li><a href="global.html#loadFirebaseImageUrl">loadFirebaseImageUrl</a></li><li><a href="global.html#loadPoemImage">loadPoemImage</a></li><li><a href="global.html#savePoemToFirestore">savePoemToFirestore</a></li><li><a href="global.html#uploadBase64ImageToStorage">uploadBase64ImageToStorage</a></li><li><a href="global.html#uploadImageToStorage">uploadImageToStorage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Jul 14 2025 15:36:26 GMT+0900 (日本標準時)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
