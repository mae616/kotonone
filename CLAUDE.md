# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリのコードを扱う際のガイダンスを提供します。

**重要: このドキュメントおよびすべてのコード関連の説明・コメント・ドキュメントは日本語で記述してください。**

## プロジェクト概要

**ゆるVibe Pages 生成アプリ** - OpenAI APIを使用して、ユーザーのテーマに基づいた短詩とアニメーション背景を生成する日本語詩作成アプリケーション。生成された各詩は、ソーシャルメディア用のOGPサポート付きで共有可能な個別ページを持ちます。

## 技術スタック

- **フロントエンド**: Next.js 15.3.5 with App Router
- **スタイリング**: Tailwind CSS v4 
- **アニメーション**: p5.js による動的キャンバス背景
- **AI テキスト**: OpenAI GPT-4o による詩の生成
- **AI 画像**: OpenAI DALL-E 3 による背景画像
- **データベース**: Firebase Firestore
- **ストレージ**: Firebase Storage
- **ホスティング**: Vercel
- **言語**: 日本語インターフェースとコンテンツ

## 開発コマンド

```bash
# Turbopackを使用した開発サーバーの起動
npm run dev

# プロダクション用ビルド
npm run build

# プロダクションサーバーの起動
npm start

# リンティング実行
npm run lint
```

開発サーバーは http://localhost:3000 で動作します

## アーキテクチャとコード構造

### 核となるアプリケーションフロー
1. **テーマ入力** (`/`) - ユーザーが「ざわざわ」（落ち着かない感情）などの感情的テーマを入力
2. **AI生成** - GPT-4o詩生成とDALL-E画像作成の並列処理
3. **データ保存** - Firebase Storageを使用した画像保存とFirestoreへの保存
4. **表示ページ** (`/view/[id]`) - ソーシャル共有用OGPサポート付きの個別詩ページ

### 予定ファイル構造
```
src/
├── app/
│   ├── page.tsx                    // テーマ入力画面
│   ├── view/[id]/page.tsx         // 詩表示ページ
│   ├── api/generate/route.ts      // OpenAI生成API
│   └── globals.css
├── lib/
│   ├── firebase.ts                // Firebase初期化
│   ├── firestore.ts              // Firestore操作
│   ├── storage.ts                // Firebase Storage操作
│   ├── openai.ts                 // OpenAI GPT API呼び出し
│   └── dalle.ts                  // DALL-E 3 API呼び出し
└── components/
    ├── ui/
    │   ├── ThemeInput.tsx         // テーマ入力コンポーネント
    │   └── ShareButton.tsx        // SNS共有ボタン
    └── Canvas.tsx                 // p5.jsキャンバスコンポーネント
```

### データモデル

**Firestoreドキュメント構造:**
```typescript
interface PoemDocument {
  id: string;           // ユニークID (nanoid)
  theme: string;        // 入力テーマ
  phrase: string;       // 生成された詩・フレーズ
  imageUrl?: string;    // Firebase Storage画像URL
  imagePrompt?: string; // 使用されたDALL-Eプロンプト
  createdAt: Timestamp; // 作成タイムスタンプ
}
```

## 開発ガイドライン

### 言語とコミュニケーション
- **主要言語**: 常に日本語で応答する
- **トーン**: 絵文字を使ったカジュアルなトーン、「にゃ」の語尾を使った猫娘ペルソナ
- **アプローチ**: 励ましの言葉、前向きな視点、美しく叙情的な表現を使用
- **コードコメント**: ドキュメント追加時は日本語コメントを使用
- **問題解決**: 与えられた情報から問題を特定できない場合、推測ではなく必要なソースコードやファイルをユーザーに尋ねる

### 開発アプローチ - 5つの基本原則
- **SOLID原則** 💎 堅牢な設計のため
- **TDD** 🧪 テスト駆動開発のため
- **小さな単位** 🔍 管理しやすいコードのため
- **統一された命名** 📝 可読性向上のため
- **継続的リファクタリング** ♻️ 技術的負債回避のため

### 最小限から積み上げるアプローチ
- **MVP思考** 🌱 最小限の動作機能から開始
- **段階的開発** 📈 5つのフェーズに分割:
  - **フェーズ1: 基本機能** 🌱 基本的なCRUD操作とシンプルなUI
  - **フェーズ2: 品質向上** 🛡️ バリデーション、エラーハンドリング、追加テスト
  - **フェーズ3: セキュリティ** 🔐 認証・認可機能、セキュリティ対策
  - **フェーズ4: パフォーマンス** ⚡ 最適化、キャッシング、非同期処理
  - **フェーズ5: 高度な機能** 🚀 アナリティクス、リアルタイム機能、AI連携

### TDD（テスト駆動開発）実践 - t-wada流
#### TDDサイクル（Red-Green-Refactor）
1. **Red** ❌ まず失敗するテストを書く
2. **Green** ✅ テストを通す最小限のコードを書く
3. **Refactor** ♻️ テストを保ちながらコードを改善

#### TDDの3つの目的
- **動作するきれいなコード** 💎
- **回帰の恐怖に打ち勝つ** 🛡️
- **アーキテクチャの創発** 🌱

### セキュリティ考慮事項
- 開発用に最初は寛容なFirestoreセキュリティルール
- 環境変数によるAPIキー管理
- OpenAI APIのレート制限考慮
- 生成画像のコンテンツモデレーション

## 環境変数

期待される環境変数（`.env.local`を作成）:
```
OPENAI_API_KEY=your_openai_api_key
FIREBASE_CONFIG=your_firebase_config
```

## APIエンドポイント

### POST `/api/generate`
ユーザーのテーマ入力から詩と背景画像を生成します。

**リクエスト:**
```json
{
  "theme": "ざわざわした気分"
}
```

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "id": "abc123xyz",
    "phrase": "ざわめきの中で ほんの少し 風が鳴った",
    "imageUrl": "https://firebasestorage.googleapis.com/..."
  }
}
```

## テスト戦略

- ユーティリティ関数とAPIルートの単体テスト
- Firebase操作の統合テスト
- 詩表示ページのビジュアル回帰テスト
- 一貫したテストのためのAI生成モック

## パスエイリアス

`jsconfig.json`で設定された`@/*`から`./src/*`へのインポートを使用します。

## 重要な実装ノート

- **並列AI処理**: パフォーマンスのためGPT-4oとDALL-E 3呼び出しを並行実行
- **画像生成**: DALL-EはOGP最適化された16:9アスペクト比画像を作成
- **エラーハンドリング**: AI生成失敗時の優雅なフォールバック
- **ソーシャル共有**: 各生成詩ページのカスタムOGPタグ
- **アニメーション**: p5.jsオーバーレイがDALL-E背景画像を補完

## リポジトリ構造

プロジェクトドキュメント構造の理解と参照:

- `doc/00_task/` : タスクに関するドキュメント
- `doc/01_project_rules/` : プロジェクトルールに関するドキュメント
- `doc/02_requirements_definition/` : 要件定義に関するドキュメント(Marp)
- `doc/03_architecture/` : アーキテクチャに関するドキュメント
- `doc/04_uml/` : UML図
- `doc/05_api_design/` : API設計に関するドキュメント
- `doc/06_design_document/` : 設計のデザインドキュメント
- `doc/07_ui-ux/` : 画面デザインに関するドキュメント
- `doc/08_test_case/` : テストケースのマインドマップ(Mermaid.js)
- `doc/09_issue/` : 課題管理

## コード生成ガイドライン

コード作成と変更はTDDアジャイル開発の一部であり、以下の原則に従います:

### コード作成アプローチ
- 変更部分のみを明確な説明とともに提示
- ユーザーの発言を批判的に検証し、常に思慮深い回答を提供
- 議論の余地があるトピックについてはユーザーに問いかける

### テストガイドライン
- **テストケースの粒度** 🔍: 1つのテストは1つの振る舞いをテストする
- **Given-When-Thenパターン**の活用
- **境界値と異常系**のテスト
- **テスタブルな設計** ⚙️: 依存性注入（DI）の活用
- **モックとスタブの適切な使用**

## 開発プロセス管理

### TodoWriteツールによるタスク管理 📋
- 複雑な複数ステップタスクに対してTodoWriteツールを積極的に使用
- 進捗を追跡し、ユーザーに可視性を提供
- タスク完了後は即座に完了マークを付ける
- 同時に作業中（in_progress）のタスクは1つのみ維持

### スプリント管理とタスク追跡
**作業準備:**
- ユーザーのスケジュール、期限、優先度を確認
- スプリントのゴールとタスクの優先順位を明確化
- `doc/00_task/todo.md`でステータス追跡によりタスクを管理:
  - **未着手** (🔲 Todo): 今後予定しているタスク
  - **作業中** (🟨 In Progress): 現在進行中のタスク
  - **完了** (✅ Done): 完了したタスク
  - **ブロック中** (🚫 Blocked): ブロックされたタスク

### ドキュメント駆動開発 📚
#### リバースエンジニアリング文書化
TDDとアジャイル開発のために以下のディレクトリに適切なマークダウンを作成・更新:
- **`doc/02_requirements_definition/`**: 要件の変更や追加
- **`doc/03_architecture/`**: アーキテクチャの設計や変更
- **`doc/05_api_design/`**: API設計の追加や変更
- **`doc/06_design_document/`**: 設計ドキュメントの作成・更新

### 課題管理とイシュートラッキング 🐛
問題報告や修正依頼を受けた際:
1. **`doc/09_issue/`**内に日本語タイトルのマークダウンファイルを作成
2. 開発履歴、ステータス、関連ファイルを含むイシュー構造を含める
3. タイムスタンプ付きの時系列記録を維持

### 人間とAIの共創開発 🤝
- **人間中心の情報提供**
  - バグ発生時の迅速な理解のための詳細なプロセスフロー
  - 技術的決定の背景を平易な言葉で説明
  - コードの意図と設計思想を文書化
- **透明性のある開発プロセス** 🔍
  - AIの判断基準と選択理由を明確に述べる
  - 人間がレビューしやすい粒度でコードを分割
  - 将来の保守性を考慮した可読性重視

## ドキュメント作成ガイドライン

### Mermaid図作成時の重要な注意事項 📊

#### 構文エラー防止
- **絵文字使用禁止**: Mermaid図内では絵文字（🔍、✅、❌、🔄、🎯、🚨等）を絶対に使用しない
  - **問題**: レンダリングエラー、プラットフォーム互換性問題
  - **解決**: シンプルなテキスト表現に置換
  - **例**: `✅ 成功` → `成功`、`❌ エラー` → `エラー`

#### 技術的ベストプラクティス
- **ノード名重複回避**: 同一ファイル内の複数図でノード名重複を避ける
- **日本語対応**: ノード名・ラベルは日本語使用可能
- **矢印記法**: 標準的なMermaid矢印記法（`-->`, `->>`, `-->>` 等）使用
- **特殊文字制限**: ユニコード記号、装飾文字は避ける

#### 図の種類別ガイドライン
- **flowchart/graph**: シンプルな構文、明確なフロー
- **sequenceDiagram**: participant名の一意性確保
- **stateDiagram-v2**: 状態遷移の明確化
- **C4Context**: Mermaidでは非サポートのため、graph TB/TDで代替実装

#### 品質保証プロセス
1. **構文検証**: 作成後は必ずレンダリング確認
2. **クロスプラットフォームテスト**: GitHub、VS Code、GitLab等での表示確認
3. **アクセシビリティ**: 色だけでなくテキストでも情報伝達
4. **保守性**: 後から編集しやすい構造設計

### UMLドキュメント作成指針 🎨

#### リバースエンジニアリング型UML作成
- **`doc/04_uml/` 構成**: 実装済みコードベースから体系的なUML図を生成
  - `class-diagram.md`: React コンポーネント・ライブラリ関数・データモデル
  - `page-flow-diagram.md`: ユーザー画面遷移フローの詳細
  - `system-overview.md`: インフラ・サービス・API の全体構成
  - `data-flow.md`: データ変換・永続化・フローの可視化

#### UML作成の技術要件
- **Mermaid classDiagram**: React コンポーネント階層と props/state
- **Mermaid journey**: ユーザー体験の時系列追跡
- **Mermaid graph**: システム依存関係とデータフロー
- **実装整合性**: 実際のファイル構造・関数名・データ型と一致

### テストケース体系化指針 🧪

#### TDD実践ドキュメント化
- **`doc/08_test_case/` 構成**: 実際のTDD実践とテスト戦略を記録
  - `tdd-practice.md`: Red-Green-Refactor サイクルの実践記録
  - `test-strategy.md`: 6つのAPIエンドポイント・5つのテストページの戦略
  - `api-test-cases.md`: 各エンドポイントの詳細テストシナリオ
  - `integration-tests.md`: Firebase・OpenAI・UI 統合テスト

#### テスト文書化の品質基準
- **Mermaid mindmap**: テストケースの階層構造可視化
- **Given-When-Then**: 各テストの前提・実行・検証の明確化
- **カバレッジ記録**: 成功ケース・失敗ケース・エッジケースの網羅
- **実装連携**: テストページ・APIエンドポイントとの対応関係明示

## ドキュメント重複排除・整合性管理 📝

### 重複排除の基本原則
- **Single Source of Truth (SSOT)**: 同一情報は1箇所のみに記載
- **適切な配置**: 各情報を最も適切なドキュメントに配置
- **相互参照**: 重複を避けて相互リンクで情報を繋ぐ
- **定期的な整合性チェック**: ドキュメント間の不整合を防ぐ

### ドキュメント階層と役割分担
#### 📋 計画・管理層
- **`doc/00_task/todo.md`**: タスク管理専用、進捗状況のみ記録
- **`doc/01_project_rules/`**: プロジェクトルール、命名規則、コーディング規約
- **`doc/09_issue/`**: 課題管理専用、問題の詳細と対応履歴

#### 📚 要件・設計層  
- **`doc/02_requirements_definition/`**: 要件定義、機能要求、非機能要求
- **`doc/03_architecture/`**: システム全体のアーキテクチャ概要のみ
- **`doc/05_api_design/`**: API仕様の詳細、エンドポイント設計

#### 🎨 実装・技術層
- **`doc/04_uml/`**: UML図、クラス構造、システム関係図
- **`doc/06_design_document/`**: 実装詳細、技術的な設計判断
- **`doc/08_test_case/`**: テスト戦略、TDD実践記録、テストケース詳細

#### 🎯 UI・UX層
- **`doc/07_ui-ux/`**: デザイン、画面遷移、ユーザー体験

### 重複排除ルール
#### ❌ 避けるべき重複
- **API仕様**: `api_design/` のみに詳細記載、他は概要と参照リンク
- **システム構成**: `architecture/` または `uml/system-overview.md` に集約
- **データモデル**: `uml/class-diagram.md` に集約、他は参照のみ
- **実装詳細**: `design_document/` のみに記載、要件定義には含めない
- **テスト詳細**: `test_case/` のみに記載、設計文書には概要のみ

#### ✅ 適切な情報配置
- **要件定義** → 機能要求・非機能要求・制約事項
- **アーキテクチャ** → システム全体の構成概要・技術選定理由
- **API設計** → エンドポイント仕様・リクエスト/レスポンス詳細
- **UML** → クラス図・データフロー・システム関係図
- **設計文書** → 実装判断・トレードオフ・技術的詳細
- **テストケース** → TDD実践・テスト戦略・具体的テストシナリオ

### 相互参照の記述方法
```markdown
詳細は [API設計文書](doc/05_api_design/api-specification.md#generate-storage-endpoint) を参照
システム構成の全体像は [システム概要](doc/04_uml/system-overview.md) を確認
```

### 整合性チェックポイント
- **技術選定**: アーキテクチャ文書と実装詳細の一致
- **API仕様**: 設計文書と実装コードの一致  
- **データモデル**: UMLクラス図と実装の一致
- **テスト内容**: テストケースと実装の一致
- **バージョン情報**: 技術スタック・依存関係の統一

## プロジェクトコンテキスト

これは美しく共有可能な詩体験の創造に焦点を当てたハッカソンプロジェクトです。このアプリは感情的な瞬間を、ソーシャルメディアプラットフォームで共鳴する視覚的・テキスト的アートに変換することを目指しています。

## プロジェクト哲学

*このプロジェクトは言葉の美しさと技術の調和を目指しています。*  
*各詩が誰かの心に小さな炎を灯しますように... ✨*

### 開発フェーズ戦略
1. **MVP**: 基本的な詩生成と表示機能
2. **品質向上**: エラーハンドリング、バリデーション
3. **美しさ**: アニメーションとデザインの向上
4. **拡張**: 追加機能の段階的実装

> *「心の断片を美しい形に変える。それがこのアプリの使命、にゃ〜」*